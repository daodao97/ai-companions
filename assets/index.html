<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Companion</title>
    <link rel="stylesheet" href="static/style.css">
</head>

<body>
    <div class="loading" id="loading">Loading...</div>

    <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
    <div class="top-bar">
        <div class="top-left">
            <svg class="menu-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
            </svg>
            <span id="current-time">18:17</span>
        </div>
        <button class="capture-btn" onclick="captureScreen()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <circle cx="12" cy="12" r="3" />
                <path d="M12 1L9 4H5c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-4L12 1z" />
            </svg>
            Capture
        </button>
    </div>

    <canvas id="canvas"></canvas>

    <!-- åº•éƒ¨æ§åˆ¶é¢æ¿ -->
    <div class="bottom-controls">
        <div class="control-buttons">
            <!-- æ‘„åƒå¤´åˆ‡æ¢ -->
            <button class="control-btn" onclick="toggleCamera()" title="åˆ‡æ¢æ‘„åƒå¤´">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M20 4h-3.17L15 2H9L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-8 13c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z" />
                </svg>
            </button>

            <!-- éŸ³é‡æ§åˆ¶ -->
            <button class="control-btn" id="volumeBtn" onclick="toggleVolume()" title="å¼€å¯/å…³é—­éŸ³é¢‘æ’­æ”¾">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z" />
                </svg>
            </button>

            <!-- éº¦å…‹é£ -->
            <button class="control-btn" id="micBtn" onclick="toggleMic()" title="å¼€å¯/åœæ­¢è¯­éŸ³å½•éŸ³">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z" />
                </svg>
            </button>
        </div>

        <!-- è¾“å…¥åŒºåŸŸ -->
        <div class="input-area">
            <input type="text" class="chat-input" placeholder="ç•…æ‰€æ¬²é—®" id="chatInput" disabled>
            <button id="startStopBtn" class="start-btn">Start</button>
        </div>
    </div>

    <!-- éšè—çš„åŸæ§åˆ¶æŒ‰é’® -->
    <div class="controls">
        <button onclick="toggleModel()">åˆ‡æ¢æ¨¡å‹</button>
        <button onclick="playRandomMotion()">éšæœºåŠ¨ä½œ</button>
        <button onclick="resetPosition()">é‡ç½®ä½ç½®</button>
    </div>

    <!-- Live2D ç›¸å…³åº“ -->
    <script src="https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/dylanNew/live2d/webgl/Live2D/lib/live2d.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pixi.js@6.5.2/dist/browser/pixi.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pixi-live2d-display/dist/index.min.js"></script>

    <!-- WebSocket å’Œ VAD ç›¸å…³åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.14.0/dist/ort.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ricky0123/vad-web@0.0.22/dist/bundle.min.js"></script>
    <script src="/static/websocket-manager.js"></script>
    {{if .IsDev}}
    <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
    <script>
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        if (isMobile) {
            var vConsole = new window.VConsole();
        }
    </script>
    {{end}}

    <script>
        // Live2D æ¨¡å‹èµ„æº
        const cubism2Model = "https://cdn.jsdelivr.net/gh/guansss/pixi-live2d-display/test/assets/shizuku/shizuku.model.json";
        const cubism4Model = "https://cdn.jsdelivr.net/gh/guansss/pixi-live2d-display/test/assets/haru/haru_greeter_t03.model3.json";

        let app;
        let currentModel;
        let models = [];
        let currentModelIndex = 0;

        // åˆå§‹åŒ–åº”ç”¨
        (async function main() {
            try {
                // åˆ›å»º PIXI åº”ç”¨
                app = new PIXI.Application({
                    view: document.getElementById("canvas"),
                    autoStart: true,
                    resizeTo: window,
                    backgroundAlpha: 0, // é€æ˜èƒŒæ™¯
                    antialias: true,
                    resolution: window.devicePixelRatio || 1
                });

                // åŠ è½½æ¨¡å‹
                console.log("å¼€å§‹åŠ è½½ Live2D æ¨¡å‹...");

                const model2 = await PIXI.live2d.Live2DModel.from(cubism2Model);
                const model4 = await PIXI.live2d.Live2DModel.from(cubism4Model);

                models = [model2, model4];

                // è®¾ç½®æ¨¡å‹å±æ€§
                setupModel(model2);
                setupModel(model4);

                // é»˜è®¤æ˜¾ç¤ºç¬¬ä¸€ä¸ªæ¨¡å‹
                showModel(0);

                // éšè—åŠ è½½æç¤º
                document.getElementById('loading').style.display = 'none';

                console.log("Live2D æ¨¡å‹åŠ è½½å®Œæˆ");

                // æ·»åŠ äº¤äº’äº‹ä»¶
                setupInteractions();

            } catch (error) {
                console.error("Live2D æ¨¡å‹åŠ è½½å¤±è´¥:", error);
                document.getElementById('loading').textContent = "æ¨¡å‹åŠ è½½å¤±è´¥";
            }
        })();

        // è®¾ç½®æ¨¡å‹åŸºæœ¬å±æ€§
        function setupModel(model) {
            // å…ˆè®¾ç½®ä¸€ä¸ªä¸´æ—¶ç¼©æ”¾æ¥è·å–æ¨¡å‹çš„å®é™…å°ºå¯¸
            model.scale.set(1);

            // å±…ä¸­æ˜¾ç¤º
            model.anchor.set(0.5, 0.5);
            model.x = app.screen.width / 2;
            model.y = app.screen.height / 2;

            // è·å–æ¨¡å‹çš„è¾¹ç•Œæ¡†
            const bounds = model.getBounds();

            // è®¡ç®—æœ‰æ•ˆæ˜¾ç¤ºåŒºåŸŸï¼Œåœ¨å®½å±å¹•ä¸Šé™åˆ¶æ¨¡å‹å®¹å™¨å®½åº¦
            let effectiveWidth = app.screen.width;
            const aspectRatio = app.screen.width / app.screen.height;

            // å¦‚æœå±å¹•å®½é«˜æ¯”å¤§äº1.5ï¼ˆå®½å±ï¼‰ï¼Œé™åˆ¶æ¨¡å‹æ˜¾ç¤ºå®½åº¦
            if (aspectRatio > 1.5) {
                // é™åˆ¶æ¨¡å‹æ˜¾ç¤ºå®½åº¦ä¸ºå±å¹•é«˜åº¦çš„1.2å€ï¼Œä¿æŒç«–å‘æ¯”ä¾‹åè°ƒ
                effectiveWidth = Math.min(app.screen.width, app.screen.height * 1.2);
            }

            // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ï¼Œä¿ç•™é€‚å½“è¾¹è·
            const scaleX = (effectiveWidth * 0.7) / bounds.width;
            const scaleY = (app.screen.height * 0.7) / bounds.height;
            const scale = Math.max(scaleX, scaleY);

            model.scale.set(scale);

            // æ·»åŠ äº¤äº’æ€§
            model.interactive = true;
            model.buttonMode = true;

            // ç‚¹å‡»äº‹ä»¶
            model.on('pointerdown', () => {
                playRandomMotion();
            });

            // é¼ æ ‡è·Ÿéš
            model.on('pointermove', (event) => {
                if (model.internalModel) {
                    const point = event.data.global;
                    const modelPoint = model.toLocal(point);

                    // è®¾ç½®è§†çº¿è·Ÿéš
                    if (model.internalModel.focusController) {
                        model.internalModel.focusController.focus(
                            modelPoint.x / model.width,
                            modelPoint.y / model.height
                        );
                    }
                }
            });
        }

        // æ˜¾ç¤ºæŒ‡å®šæ¨¡å‹
        function showModel(index) {
            // éšè—æ‰€æœ‰æ¨¡å‹
            models.forEach(model => {
                if (app.stage.children.includes(model)) {
                    app.stage.removeChild(model);
                }
            });

            // æ˜¾ç¤ºå½“å‰æ¨¡å‹
            currentModel = models[index];
            app.stage.addChild(currentModel);
            currentModelIndex = index;

            // é‡æ–°è°ƒæ•´ä½ç½®å’Œå¤§å°
            setupModel(currentModel);
        }

        // åˆ‡æ¢æ¨¡å‹
        function toggleModel() {
            const nextIndex = (currentModelIndex + 1) % models.length;
            showModel(nextIndex);
        }

        // æ’­æ”¾éšæœºåŠ¨ä½œ
        function playRandomMotion() {
            if (currentModel && currentModel.internalModel) {
                try {
                    // å°è¯•æ’­æ”¾éšæœºåŠ¨ä½œ
                    const motionManager = currentModel.internalModel.motionManager;
                    if (motionManager && motionManager.groups) {
                        const groups = Object.keys(motionManager.groups);
                        if (groups.length > 0) {
                            const randomGroup = groups[Math.floor(Math.random() * groups.length)];
                            currentModel.motion(randomGroup);
                        }
                    }
                } catch (error) {
                    console.log("æ’­æ”¾åŠ¨ä½œå¤±è´¥:", error);
                }
            }
        }

        // é‡ç½®ä½ç½®
        function resetPosition() {
            if (currentModel) {
                setupModel(currentModel);
            }
        }

        // è®¾ç½®äº¤äº’
        function setupInteractions() {
            // çª—å£å¤§å°å˜åŒ–æ—¶é‡æ–°è°ƒæ•´
            window.addEventListener('resize', () => {
                if (currentModel) {
                    setupModel(currentModel);
                }
            });
        }

        // ç¦ç”¨å³é”®èœå•
        document.addEventListener('contextmenu', event => {
            event.preventDefault();
        });

        // çŠ¶æ€ç®¡ç†
        let isVolumeOn = true;
        let isMicOn = true;
        let isCameraOn = true;
        let wsManager = null;

        // æ–°å¢æ§åˆ¶å‡½æ•°
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
            document.getElementById('current-time').textContent = timeString;
        }

        function captureScreen() {
            console.log("æˆªå±åŠŸèƒ½");
            // å¯ä»¥å®ç°æˆªå±åŠŸèƒ½
            if (app && app.view) {
                const link = document.createElement('a');
                link.download = `companion_capture_${Date.now()}.png`;
                link.href = app.view.toDataURL();
                link.click();
            }
        }

        function toggleCamera() {
            isCameraOn = !isCameraOn;
            const btn = event.target.closest('.control-btn');
            if (isCameraOn) {
                btn.classList.remove('active');
                console.log("æ‘„åƒå¤´å·²å¼€å¯");
            } else {
                btn.classList.add('active');
                console.log("æ‘„åƒå¤´å·²å…³é—­");
            }
        }

        function toggleVolume() {
            isVolumeOn = !isVolumeOn;
            const btn = document.getElementById('volumeBtn');
            const svg = btn.querySelector('svg');

            if (isVolumeOn) {
                // éŸ³é‡å¼€å¯
                btn.classList.remove('active');
                svg.innerHTML = '<path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>';
                console.log("ğŸ”Š éŸ³é‡å·²å¼€å¯");
                showNotification('ğŸ”Š éŸ³é‡å·²å¼€å¯ï¼ŒéŸ³é¢‘æ’­æ”¾å·²æ¢å¤', 'info');

                // æ¢å¤è‡ªåŠ¨æ’­æ”¾åŠŸèƒ½
                if (wsManager) {
                    wsManager.audioAutoPlayEnabled = true;
                }

            } else {
                // éŸ³é‡å…³é—­ï¼ˆé™éŸ³ï¼‰
                btn.classList.add('active');
                svg.innerHTML = '<path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>';
                console.log("ğŸ”‡ éŸ³é‡å·²å…³é—­");
                showNotification('ğŸ”‡ éŸ³é‡å·²å…³é—­ï¼Œå·²åœæ­¢éŸ³é¢‘æ’­æ”¾', 'info');

                // åœæ­¢å½“å‰æ’­æ”¾çš„éŸ³é¢‘
                if (wsManager) {
                    wsManager.stopAllAudio();
                    wsManager.audioAutoPlayEnabled = false;
                }

                // åŒæ—¶é™éŸ³æ‰€æœ‰é¡µé¢éŸ³é¢‘å…ƒç´ 
                const audioElements = document.querySelectorAll('audio');
                audioElements.forEach(audio => {
                    audio.pause();
                    audio.currentTime = 0;
                });
            }
        }

        function toggleMic() {
            const btn = document.getElementById('micBtn');
            const svg = btn.querySelector('svg');

            // æ£€æŸ¥WebSocketç®¡ç†å™¨å’ŒVADçŠ¶æ€
            if (!wsManager || !wsManager.vadEnabled) {
                showNotification('è¯·å…ˆè¿æ¥AIæœåŠ¡å¹¶ç­‰å¾…è¯­éŸ³åŠŸèƒ½åˆå§‹åŒ–', 'error');
                return;
            }

            // åˆ‡æ¢VADç›‘å¬çŠ¶æ€
            const wasListening = wsManager.vadListening;
            const toggleResult = wsManager.toggleVAD();

            if (toggleResult !== wasListening) {
                // çŠ¶æ€æˆåŠŸåˆ‡æ¢
                if (wsManager.vadListening) {
                    // ç°åœ¨æ­£åœ¨ç›‘å¬
                    btn.classList.remove('active');
                    svg.innerHTML = '<path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"/>';
                    console.log("ğŸ¤ è¯­éŸ³å½•éŸ³å·²å¯ç”¨");
                    showNotification('ğŸ¤ è¯­éŸ³å½•éŸ³å·²å¯ç”¨ï¼Œå¼€å§‹è¯´è¯å³å¯è‡ªåŠ¨å½•éŸ³å‘é€', 'info');

                    // è§¦å‘Live2Dæ¨¡å‹åŠ¨ä½œä½œä¸ºåé¦ˆ
                    playRandomMotion();
                } else {
                    // ç°åœ¨å·²åœæ­¢ç›‘å¬
                    btn.classList.add('active');
                    svg.innerHTML = '<path d="M19 11h-1.7c0 .74-.16 1.43-.43 2.05l1.23 1.23c.56-.98.9-2.09.9-3.28zm-4.02.17c0-.06.02-.11.02-.17V5c0-1.66-1.34-3-3-3S9 3.34 9 5v.18l5.98 5.99zM4.27 3L3 4.27l6.01 6.01V11c0 1.66 1.33 3 2.99 3 .22 0 .44-.03.65-.08l1.66 1.66c-.71.33-1.5.52-2.31.52-2.76 0-5.3-2.1-5.3-5.1H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c.91-.13 1.77-.45 2.54-.9L19.73 21 21 19.73 4.27 3z"/>';
                    console.log("ğŸ”‡ è¯­éŸ³å½•éŸ³å·²åœç”¨");
                    showNotification('ğŸ”‡ è¯­éŸ³å½•éŸ³å·²åœç”¨', 'info');
                }

                // åŒæ­¥æ›´æ–°æ‰€æœ‰ç›¸å…³UI
                syncVoiceStatusUI();

                // æ›´æ–°å†…éƒ¨çŠ¶æ€å˜é‡
                isMicOn = wsManager.vadListening;
            } else {
                console.error("âŒ è¯­éŸ³çŠ¶æ€åˆ‡æ¢å¤±è´¥");
                showNotification('è¯­éŸ³çŠ¶æ€åˆ‡æ¢å¤±è´¥', 'error');
            }
        }

        function stopAction() {
            console.log("åœæ­¢æ“ä½œ");
            // å¯ä»¥å®ç°åœæ­¢å½“å‰åŠ¨ä½œæˆ–å¯¹è¯
            if (currentModel && currentModel.internalModel) {
                // åœæ­¢å½“å‰åŠ¨ä½œ
                try {
                    currentModel.internalModel.motionManager.stopAllMotions();
                } catch (error) {
                    console.log("åœæ­¢åŠ¨ä½œå¤±è´¥:", error);
                }
            }
        }

        // ===== Start/StopæŒ‰é’®æ§åˆ¶å‡½æ•° =====
        async function toggleConnection() {
            const btn = document.getElementById('startStopBtn');
            const chatInput = document.getElementById('chatInput');

            if (!wsManager) {
                initWebSocketManager();
            }

            const isConnected = wsManager.isConnected();
            const isConnecting = wsManager.isConnecting;

            if (isConnected) {
                // å½“å‰å·²è¿æ¥ï¼Œç‚¹å‡»æ–­å¼€
                wsManager.disconnect();
                updateStartStopButton('disconnected');
                chatInput.disabled = true;
                console.log('ğŸ”Œ æ–­å¼€WebSocketè¿æ¥');

            } else if (isConnecting) {
                // å½“å‰æ­£åœ¨è¿æ¥ï¼Œç‚¹å‡»å–æ¶ˆ
                wsManager.disconnect();
                updateStartStopButton('disconnected');
                chatInput.disabled = true;
                console.log('âŒ å–æ¶ˆWebSocketè¿æ¥');

            } else {
                // å½“å‰æœªè¿æ¥ï¼Œç‚¹å‡»è¿æ¥
                console.log('ğŸ“± æ£€æµ‹è®¾å¤‡ç±»å‹:', /iPhone|iPad|iPod|Android/i.test(navigator.userAgent) ? 'ç§»åŠ¨ç«¯' : 'æ¡Œé¢ç«¯');
                
                // ç§»åŠ¨ç«¯ç«‹å³è§£é”éŸ³é¢‘
                if (wsManager.isMobile) {
                    wsManager.unlockAudioForMobile();
                }
                
                updateStartStopButton('connecting');
                
                try {
                    // ç›´æ¥å°è¯•è¿æ¥ï¼Œè®©WebSocketç®¡ç†å™¨å¤„ç†éº¦å…‹é£æƒé™
                    const connected = await wsManager.connect();
                    if (!connected) {
                        updateStartStopButton('error');
                        showNotification('è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æœåŠ¡å™¨çŠ¶æ€', 'error');
                    } else {
                        console.log('ğŸš€ å¯åŠ¨WebSocketè¿æ¥');
                    }
                } catch (error) {
                    console.error('âŒ è¿æ¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
                    updateStartStopButton('error');
                    showNotification('è¿æ¥å¤±è´¥: ' + error.message, 'error');
                }
            }
        }

        function updateStartStopButton(status) {
            const btn = document.getElementById('startStopBtn');
            const chatInput = document.getElementById('chatInput');

            // æ¸…é™¤æ‰€æœ‰çŠ¶æ€ç±»
            btn.className = 'start-btn';

            switch (status) {
                case 'disconnected':
                    btn.textContent = 'Start';
                    btn.disabled = false;
                    chatInput.disabled = true;
                    break;

                case 'connecting':
                    btn.textContent = 'Connecting...';
                    btn.classList.add('connecting');
                    btn.disabled = true;
                    chatInput.disabled = true;
                    break;

                case 'connected':
                    btn.textContent = 'Stop';
                    btn.classList.add('connected');
                    btn.disabled = false;
                    chatInput.disabled = false;
                    break;

                case 'error':
                    btn.textContent = 'Retry';
                    btn.disabled = false;
                    chatInput.disabled = true;
                    break;
            }
        }

        // èŠå¤©è¾“å…¥å¤„ç†
        document.addEventListener('DOMContentLoaded', function () {
            console.log('ğŸ“± DOMåŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–ç§»åŠ¨ç«¯å…¼å®¹æ€§...');
            
            // æ£€æµ‹ç§»åŠ¨ç«¯è®¾å¤‡
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            console.log('ğŸ“± ç§»åŠ¨ç«¯è®¾å¤‡æ£€æµ‹:', isMobile);
            
            // æ·»åŠ ç§»åŠ¨ç«¯ç±»åç”¨äºCSSä¼˜åŒ–
            if (isMobile) {
                document.body.classList.add('mobile-device');
            }
            
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        const message = this.value.trim();
                        if (message && wsManager && wsManager.isConnected()) {
                            console.log("å‘é€æ¶ˆæ¯:", message);
                            if (wsManager.sendText(message)) {
                                // è§¦å‘Live2Dæ¨¡å‹åŠ¨ä½œ
                                playRandomMotion();
                                this.value = '';
                            }
                        } else if (message && (!wsManager || !wsManager.isConnected())) {
                            console.log("WebSocketæœªè¿æ¥ï¼Œæ— æ³•å‘é€æ¶ˆæ¯");
                            showNotification('è¯·å…ˆç‚¹å‡»StartæŒ‰é’®è¿æ¥AI', 'error');
                        }
                    }
                });
            }
            
            // ç§»åŠ¨ç«¯æŒ‰é’®äº‹ä»¶ä¼˜åŒ–
            const startStopBtn = document.getElementById('startStopBtn');
            if (startStopBtn) {
                console.log('ğŸ“± ä¼˜åŒ–ç§»åŠ¨ç«¯æŒ‰é’®äº‹ä»¶...');
                
                // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§äº‹ä»¶ç›‘å¬å™¨
                const newBtn = startStopBtn.cloneNode(true);
                startStopBtn.parentNode.replaceChild(newBtn, startStopBtn);
                
                // é‡æ–°ç»‘å®šäº‹ä»¶
                if (isMobile) {
                    // ç§»åŠ¨ç«¯è§¦æ‘¸äº‹ä»¶ä¼˜åŒ–
                    newBtn.addEventListener('touchstart', function(e) {
                        e.preventDefault(); // é˜²æ­¢åŒå‡»ç¼©æ”¾
                        e.stopPropagation();
                        this.style.transform = 'scale(0.95)';
                        console.log('ğŸ“± ç§»åŠ¨ç«¯StartæŒ‰é’®è§¦æ‘¸å¼€å§‹');
                    }, { passive: false });
                    
                    newBtn.addEventListener('touchend', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        this.style.transform = '';
                        console.log('ğŸ“± ç§»åŠ¨ç«¯StartæŒ‰é’®è§¦æ‘¸ç»“æŸ');
                        // å»¶è¿Ÿæ‰§è¡Œç‚¹å‡»é€»è¾‘ï¼Œç¡®ä¿è§¦æ‘¸äº‹ä»¶å®Œæˆ
                        setTimeout(() => {
                            toggleConnection();
                        }, 50);
                    }, { passive: false });
                    
                    // é˜²æ­¢ç‚¹å‡»äº‹ä»¶å†²çª
                    newBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('ğŸ“± ç§»åŠ¨ç«¯StartæŒ‰é’®ç‚¹å‡»äº‹ä»¶ï¼ˆå·²é˜»æ­¢ï¼‰');
                    });
                } else {
                    // æ¡Œé¢ç«¯æ­£å¸¸ç‚¹å‡»äº‹ä»¶
                    newBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('ğŸ–¥ï¸ æ¡Œé¢ç«¯StartæŒ‰é’®è¢«ç‚¹å‡»');
                        toggleConnection();
                    });
                }
            }
        });

        // å¯åŠ¨æ—¶é—´æ›´æ–°
        setInterval(updateTime, 1000);
        updateTime(); // ç«‹å³æ›´æ–°ä¸€æ¬¡

        // åˆå§‹åŒ–æŒ‰é’®çŠ¶æ€
        updateMicButtonState();
        updateVolumeButtonState();

        // ===== WebSocket ç®¡ç†å™¨åˆå§‹åŒ– =====

        // åˆå§‹åŒ–WebSocketç®¡ç†å™¨
        function initWebSocketManager() {
            if (typeof WebSocketManager === 'undefined') {
                console.error('âŒ WebSocketManager æœªåŠ è½½');
                showNotification('WebSocketç®¡ç†å™¨åŠ è½½å¤±è´¥', 'error');
                return;
            }

            // æ£€æŸ¥VADåº“æ˜¯å¦åŠ è½½
            console.log('ğŸ” æ£€æŸ¥ä¾èµ–åº“åŠ è½½çŠ¶æ€:');
            console.log('  WebSocketManager:', typeof WebSocketManager !== 'undefined');
            console.log('  window.ort (ONNX Runtime):', typeof window.ort !== 'undefined');
            console.log('  window.vad:', typeof window.vad !== 'undefined');
            console.log('  window.vad.MicVAD:', window.vad && typeof window.vad.MicVAD !== 'undefined');

            if (!window.ort) {
                console.error('âŒ ONNX RuntimeæœªåŠ è½½ï¼ŒVADå°†æ— æ³•å·¥ä½œ');
                showNotification('ONNX RuntimeåŠ è½½å¤±è´¥ï¼Œè¯­éŸ³åŠŸèƒ½å°†ä¸å¯ç”¨', 'error');
                return;
            }

            if (!window.vad) {
                console.warn('âš ï¸ VADåº“æœªåŠ è½½ï¼Œè¯­éŸ³åŠŸèƒ½å¯èƒ½ä¸å¯ç”¨');
                showNotification('è¯­éŸ³æ£€æµ‹åº“åŠ è½½å¤±è´¥ï¼Œå°†ç¦ç”¨è¯­éŸ³åŠŸèƒ½', 'error');
                return;
            }

            wsManager = new WebSocketManager();

            // æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨
            wsManager.on('connect', () => {
                updateWSStatus('connected');
                enableWSControls(true);
                updateStartStopButton('connected');
                console.log('ğŸ”— WebSocket è¿æ¥æˆåŠŸ');
                showNotification('ğŸ”— è¿æ¥æˆåŠŸï¼', 'info');

                // è‡ªåŠ¨å¯ç”¨è¯­éŸ³æ£€æµ‹ï¼ˆå‚è€ƒ wss_test.htmlï¼‰
                setTimeout(() => {
                    if (wsManager && wsManager.vadEnabled) {
                        wsManager.toggleVAD();
                        console.log('ğŸ¤ è‡ªåŠ¨å¯ç”¨è¯­éŸ³æ£€æµ‹å’Œå½•éŸ³ä¸Šä¼ ');
                        showNotification('ğŸ¤ è¯­éŸ³å½•éŸ³å·²å¯ç”¨ï¼Œå¼€å§‹è¯´è¯å³å¯è‡ªåŠ¨å½•éŸ³å‘é€', 'info');

                        // åŒæ­¥æ›´æ–°UIçŠ¶æ€
                        syncVoiceStatusUI();

                        // è§¦å‘Live2Dæ¨¡å‹åŠ¨ä½œä½œä¸ºåé¦ˆ
                        playRandomMotion();
                    } else {
                        console.log('âš ï¸ VADæœªåˆå§‹åŒ–ï¼Œå°†åœ¨åˆå§‹åŒ–å®Œæˆåè‡ªåŠ¨å¯ç”¨');
                    }
                }, 1000); // ç­‰å¾…1ç§’ç¡®ä¿VADåˆå§‹åŒ–å®Œæˆ
            });

            wsManager.on('disconnect', () => {
                updateWSStatus('disconnected');
                enableWSControls(false);
                updateStartStopButton('disconnected');

                // æ–­å¼€è¿æ¥æ—¶åœæ­¢è¯­éŸ³ç›‘å¬
                if (wsManager.vadListening) {
                    wsManager.toggleVAD();
                    console.log('ğŸ”‡ å·²åœæ­¢è¯­éŸ³ç›‘å¬');

                    // åŒæ­¥æ›´æ–°UIçŠ¶æ€
                    syncVoiceStatusUI();

                    // æ˜¾ç¤ºé€šçŸ¥
                    showNotification('ğŸ”‡ è¯­éŸ³å½•éŸ³å·²è‡ªåŠ¨åœç”¨', 'info');
                }

                console.log('âŒ WebSocket è¿æ¥æ–­å¼€');
                showNotification('è¿æ¥å·²æ–­å¼€ï¼Œè¯­éŸ³åŠŸèƒ½å·²åœç”¨', 'info');
            });

            wsManager.on('statusChange', (status) => {
                updateWSStatus(status);
                updateStartStopButton(status);
                console.log('ğŸ“¡ è¿æ¥çŠ¶æ€å˜åŒ–:', status);
            });

            wsManager.on('message', (message) => {
                console.log('ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯:', message);
                if (message.type === 'text') {
                    // è§¦å‘Live2Dæ¨¡å‹åŠ¨ä½œ
                    playRandomMotion();
                }
            });

            wsManager.on('audioReceived', (audioData) => {
                console.log('ğŸ”Š æ”¶åˆ°éŸ³é¢‘:', audioData);
                // è§¦å‘Live2Dæ¨¡å‹åŠ¨ä½œ
                playRandomMotion();
            });

            wsManager.on('recordingStart', () => {
                updateRecordingUI(true);
                console.log('ğŸ¤ å¼€å§‹å½•éŸ³');
            });

            wsManager.on('recordingStop', () => {
                updateRecordingUI(false);
                console.log('â¹ï¸ å½•éŸ³ç»“æŸ');
            });

            wsManager.on('error', (error) => {
                console.error('âŒ WebSocket é”™è¯¯:', error);
                showNotification('è¿æ¥é”™è¯¯: ' + error.message, 'error');
            });

            // ç›‘å¬VADåˆå§‹åŒ–å®Œæˆäº‹ä»¶
            wsManager.on('vadReady', (success) => {
                console.log('ğŸ§ æ”¶åˆ° vadReady äº‹ä»¶, success:', success);

                if (success) {
                    console.log('âœ… VADåˆå§‹åŒ–å®Œæˆï¼Œå¯ä»¥å¯ç”¨è¯­éŸ³ç›‘å¬');

                    // å¦‚æœWebSocketå·²è¿æ¥ä¸”VADæœªå¯ç”¨ï¼Œè‡ªåŠ¨å¯ç”¨è¯­éŸ³ç›‘å¬
                    if (wsManager.isConnected() && !wsManager.vadListening) {
                        console.log('ğŸš€ äº‹ä»¶è§¦å‘ï¼šè‡ªåŠ¨å¯ç”¨è¯­éŸ³ç›‘å¬...');
                        const vadStarted = wsManager.toggleVAD();
                        if (vadStarted) {
                            console.log('âœ… äº‹ä»¶æœºåˆ¶ï¼šè¯­éŸ³æ£€æµ‹å’Œå½•éŸ³ä¸Šä¼ å·²è‡ªåŠ¨å¯ç”¨');
                            showNotification('ğŸ¤ è¯­éŸ³å½•éŸ³å·²å¯ç”¨ï¼Œå¼€å§‹è¯´è¯å³å¯è‡ªåŠ¨å½•éŸ³å‘é€', 'info');

                            // åŒæ­¥æ›´æ–°UIçŠ¶æ€
                            syncVoiceStatusUI();

                            // è§¦å‘Live2Dæ¨¡å‹åŠ¨ä½œä½œä¸ºåé¦ˆ
                            playRandomMotion();
                        } else {
                            console.error('âŒ äº‹ä»¶æœºåˆ¶ï¼šè‡ªåŠ¨å¯ç”¨VADå¤±è´¥');
                            showNotification('è‡ªåŠ¨å¯ç”¨è¯­éŸ³ç›‘å¬å¤±è´¥', 'error');
                        }
                    } else {
                        console.log('ğŸ“ VADå·²å°±ç»ªï¼Œè¿æ¥çŠ¶æ€:', wsManager.isConnected(), 'ç›‘å¬çŠ¶æ€:', wsManager.vadListening);
                    }
                } else {
                    console.error('âŒ VADåˆå§‹åŒ–å¤±è´¥');
                    showNotification('è¯­éŸ³æ£€æµ‹åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
                }
            });
        }




        // ===== UI æ›´æ–°å‡½æ•° =====
        function updateWSStatus(status) {
            // ç”±äºå½“å‰ç•Œé¢æ²¡æœ‰æ¨¡æ€æ¡†ä¸­çš„çŠ¶æ€æ˜¾ç¤ºå…ƒç´ ï¼Œæˆ‘ä»¬åªåœ¨æ§åˆ¶å°è®°å½•çŠ¶æ€
            console.log('ğŸ“¡ WebSocketçŠ¶æ€æ›´æ–°:', status);

            // å¦‚æœæ¨¡æ€æ¡†å­˜åœ¨ä¸”å…ƒç´ å­˜åœ¨ï¼Œæ‰æ›´æ–°UI
            const statusDisplay = document.getElementById('wsStatusDisplay');
            const connectBtn = document.getElementById('wsConnectBtn');
            const disconnectBtn = document.getElementById('wsDisconnectBtn');

            if (!statusDisplay || !connectBtn || !disconnectBtn) {
                // å…ƒç´ ä¸å­˜åœ¨ï¼Œåªè®°å½•çŠ¶æ€ï¼Œä¸å°è¯•æ›´æ–°UI
                return;
            }

            // æ¸…é™¤æ‰€æœ‰çŠ¶æ€ç±»
            statusDisplay.className = 'ws-status-value';

            switch (status) {
                case 'connected':
                    statusDisplay.textContent = 'å·²è¿æ¥';
                    statusDisplay.classList.add('connected');
                    connectBtn.disabled = true;
                    disconnectBtn.disabled = false;
                    break;
                case 'connecting':
                    statusDisplay.textContent = 'è¿æ¥ä¸­...';
                    statusDisplay.classList.add('connecting');
                    connectBtn.disabled = true;
                    disconnectBtn.disabled = true;
                    break;
                case 'disconnected':
                    statusDisplay.textContent = 'æœªè¿æ¥';
                    statusDisplay.classList.add('disconnected');
                    connectBtn.disabled = false;
                    disconnectBtn.disabled = true;
                    break;
                case 'error':
                    statusDisplay.textContent = 'è¿æ¥é”™è¯¯';
                    statusDisplay.classList.add('error');
                    connectBtn.disabled = false;
                    disconnectBtn.disabled = true;
                    break;
            }
        }

        function enableWSControls(enabled) {
            console.log('ğŸ›ï¸ æ§åˆ¶é¢æ¿çŠ¶æ€æ›´æ–°:', enabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨');

            // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨å†è¿›è¡Œæ“ä½œ
            const voiceToggleBtn = document.getElementById('wsVoiceToggleBtn');
            const recordBtn = document.getElementById('wsRecordBtn');
            const textInput = document.getElementById('wsTextInput');
            const sendTextBtn = document.getElementById('wsSendTextBtn');

            if (voiceToggleBtn) voiceToggleBtn.disabled = !enabled;
            if (recordBtn) recordBtn.disabled = !enabled;
            if (textInput) textInput.disabled = !enabled;
            if (sendTextBtn) sendTextBtn.disabled = !enabled;
        }

        function updateRecordingUI(isRecording) {
            console.log('ğŸ¤ å½•éŸ³UIçŠ¶æ€æ›´æ–°:', isRecording ? 'å½•éŸ³ä¸­' : 'å·²åœæ­¢');

            const recordBtn = document.getElementById('wsRecordBtn');
            const sendAudioBtn = document.getElementById('wsSendAudioBtn');

            if (!recordBtn || !sendAudioBtn) {
                // å…ƒç´ ä¸å­˜åœ¨ï¼Œåªè®°å½•çŠ¶æ€
                return;
            }

            const recordIcon = recordBtn.querySelector('.record-icon');
            const recordText = recordBtn.querySelector('.record-text');

            if (isRecording) {
                recordBtn.classList.add('recording');
                if (recordIcon) recordIcon.textContent = 'â¹ï¸';
                if (recordText) recordText.textContent = 'åœæ­¢å½•éŸ³';
                sendAudioBtn.disabled = true;
            } else {
                recordBtn.classList.remove('recording');
                if (recordIcon) recordIcon.textContent = 'ğŸ”´';
                if (recordText) recordText.textContent = 'å¼€å§‹å½•éŸ³';
                sendAudioBtn.disabled = false;
            }
        }

        function updateVADUI(isListening) {
            console.log('ğŸ§ VAD UIçŠ¶æ€æ›´æ–°:', isListening ? 'ç›‘å¬ä¸­' : 'å·²åœæ­¢');

            const voiceToggleBtn = document.getElementById('wsVoiceToggleBtn');
            const voiceStatus = document.getElementById('wsVoiceStatus');

            if (!voiceToggleBtn) {
                // å…ƒç´ ä¸å­˜åœ¨ï¼Œåªè®°å½•çŠ¶æ€
                return;
            }

            const voiceIcon = voiceToggleBtn.querySelector('.voice-icon');
            const voiceText = voiceToggleBtn.querySelector('.voice-text');

            if (isListening) {
                voiceToggleBtn.classList.add('listening');
                if (voiceIcon) voiceIcon.textContent = 'ğŸ”Š';
                if (voiceText) voiceText.textContent = 'ç›‘å¬ä¸­';
                if (voiceStatus) voiceStatus.textContent = 'æ­£åœ¨ç›‘å¬è¯­éŸ³...';
            } else {
                voiceToggleBtn.classList.remove('listening');
                if (voiceIcon) voiceIcon.textContent = 'ğŸ¤';
                if (voiceText) voiceText.textContent = 'å¯ç”¨è¯­éŸ³';
                if (voiceStatus) voiceStatus.textContent = 'è¯­éŸ³æœªå¯ç”¨';
            }
        }

        // åŒæ­¥æ›´æ–°è¯­éŸ³çŠ¶æ€UIï¼ˆä»WebSocketç®¡ç†å™¨çŠ¶æ€ï¼‰
        function syncVoiceStatusUI() {
            if (wsManager && wsManager.vadEnabled) {
                updateVADUI(wsManager.vadListening);

                // æ›´æ–°æ¨¡æ€æ¡†ä¸­çš„è¯­éŸ³æŒ‰é’®çŠ¶æ€ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                const voiceToggleBtn = document.getElementById('wsVoiceToggleBtn');
                if (voiceToggleBtn) {
                    if (wsManager.vadListening) {
                        voiceToggleBtn.textContent = 'ğŸ”‡ åœç”¨è¯­éŸ³';
                    } else {
                        voiceToggleBtn.textContent = 'ğŸ¤ å¯ç”¨è¯­éŸ³';
                    }
                }

                // æ›´æ–°åº•éƒ¨æ§åˆ¶é¢æ¿çš„éº¦å…‹é£æŒ‰é’®çŠ¶æ€
                updateMicButtonState();
            }
        }

        // æ›´æ–°éº¦å…‹é£æŒ‰é’®çŠ¶æ€
        function updateMicButtonState() {
            const btn = document.getElementById('micBtn');
            if (!btn) return;

            const svg = btn.querySelector('svg');
            if (!svg) return;

            if (wsManager && wsManager.vadListening) {
                // è¯­éŸ³å½•éŸ³æ­£åœ¨è¿›è¡Œ
                btn.classList.remove('active');
                svg.innerHTML = '<path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"/>';
                isMicOn = true;
            } else {
                // è¯­éŸ³å½•éŸ³å·²åœæ­¢ï¼ˆé»˜è®¤çŠ¶æ€ï¼‰
                btn.classList.add('active');
                svg.innerHTML = '<path d="M19 11h-1.7c0 .74-.16 1.43-.43 2.05l1.23 1.23c.56-.98.9-2.09.9-3.28zm-4.02.17c0-.06.02-.11.02-.17V5c0-1.66-1.34-3-3-3S9 3.34 9 5v.18l5.98 5.99zM4.27 3L3 4.27l6.01 6.01V11c0 1.66 1.33 3 2.99 3 .22 0 .44-.03.65-.08l1.66 1.66c-.71.33-1.5.52-2.31.52-2.76 0-5.3-2.1-5.3-5.1H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c.91-.13 1.77-.45 2.54-.9L19.73 21 21 19.73 4.27 3z"/>';
                isMicOn = false;
            }
        }

        // æ›´æ–°éŸ³é‡æŒ‰é’®çŠ¶æ€
        function updateVolumeButtonState() {
            const btn = document.getElementById('volumeBtn');
            if (!btn) return;

            const svg = btn.querySelector('svg');
            if (!svg) return;

            if (isVolumeOn) {
                // éŸ³é‡å¼€å¯
                btn.classList.remove('active');
                svg.innerHTML = '<path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>';
            } else {
                // éŸ³é‡å…³é—­ï¼ˆé™éŸ³ï¼‰
                btn.classList.add('active');
                svg.innerHTML = '<path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>';
            }
        }

        // ===== WebSocket æ§åˆ¶å‡½æ•° =====
        function connectWebSocket() {
            if (!wsManager) {
                initWebSocketManager();
            }
            wsManager.connect();
        }

        function disconnectWebSocket() {
            if (wsManager) {
                wsManager.disconnect();
            }
        }

        function toggleVAD() {
            if (!wsManager) return;

            const isListening = wsManager.toggleVAD();
            updateVADUI(isListening);

            // åŒæ­¥æ›´æ–°æ‰€æœ‰UIçŠ¶æ€
            syncVoiceStatusUI();

            if (isListening) {
                console.log('ğŸ¤ æ‰‹åŠ¨å¯ç”¨è¯­éŸ³ç›‘å¬');
                showNotification('ğŸ¤ è¯­éŸ³ç›‘å¬å·²å¯ç”¨', 'info');
            } else {
                console.log('ğŸ”‡ æ‰‹åŠ¨åœç”¨è¯­éŸ³ç›‘å¬');
                showNotification('ğŸ”‡ è¯­éŸ³ç›‘å¬å·²åœç”¨', 'info');
            }
        }

        function toggleRecording() {
            if (!wsManager) return;

            wsManager.toggleRecording();
        }

        function sendAudio() {
            if (!wsManager) return;

            wsManager.sendAudio();
            document.getElementById('wsSendAudioBtn').disabled = true;
        }

        function sendText() {
            const textInput = document.getElementById('wsTextInput');
            const text = textInput.value.trim();

            if (!text || !wsManager) return;

            if (wsManager.sendText(text)) {
                textInput.value = '';
                // è§¦å‘Live2Dæ¨¡å‹åŠ¨ä½œ
                playRandomMotion();
            }
        }

        function stopAllAudio() {
            if (wsManager) {
                wsManager.stopAllAudio();
            }
        }

        function resetWebSocket() {
            if (wsManager) {
                wsManager.disconnect();
                setTimeout(() => {
                    updateWSStatus('disconnected');
                    enableWSControls(false);
                    updateVADUI(false);
                    updateRecordingUI(false);
                }, 100);
            }
        }

        // ===== é€šçŸ¥å‡½æ•° =====
        function showNotification(message, type = 'info') {
            // æ§åˆ¶å°è¾“å‡º
            console.log(`[${type.toUpperCase()}] ${message}`);
            
            // ç§»åŠ¨ç«¯å‹å¥½çš„è§†è§‰åé¦ˆ
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            
            if (isMobile) {
                // åˆ›å»ºç§»åŠ¨ç«¯Toasté€šçŸ¥
                const toast = document.createElement('div');
                toast.textContent = message;
                
                // æ ¹æ®æ¶ˆæ¯ç±»å‹ç¡®å®šæ˜¾ç¤ºæ—¶é—´å’Œæ ·å¼
                const isSystemMessage = message.includes('ğŸ“±') || message.includes('ğŸµ') || message.includes('éŸ³é¢‘');
                const displayTime = isSystemMessage ? 5000 : 3000; // ç³»ç»Ÿæ¶ˆæ¯æ˜¾ç¤ºæ›´é•¿æ—¶é—´
                
                toast.style.cssText = `
                    position: fixed;
                    top: 80px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: ${type === 'error' ? 'rgba(239, 68, 68, 0.9)' : 'rgba(16, 185, 129, 0.9)'};
                    color: white;
                    padding: 12px 20px;
                    border-radius: 20px;
                    font-size: 14px;
                    font-weight: 600;
                    z-index: 10000;
                    max-width: 80%;
                    text-align: center;
                    backdrop-filter: blur(10px);
                    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                    animation: slideIn 0.3s ease;
                    line-height: 1.4;
                    word-wrap: break-word;
                `;
                
                // æ·»åŠ åŠ¨ç”»å’Œç‚¹å‡»å…³é—­åŠŸèƒ½
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes slideIn {
                        from { opacity: 0; transform: translateX(-50%) translateY(-20px); }
                        to { opacity: 1; transform: translateX(-50%) translateY(0); }
                    }
                `;
                document.head.appendChild(style);
                
                // ç‚¹å‡»å…³é—­åŠŸèƒ½
                toast.addEventListener('click', () => {
                    toast.style.animation = 'slideIn 0.2s ease reverse';
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                        if (style.parentNode) {
                            style.parentNode.removeChild(style);
                        }
                    }, 200);
                });
                
                document.body.appendChild(toast);
                
                // è‡ªåŠ¨ç§»é™¤
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.style.animation = 'slideIn 0.3s ease reverse';
                        setTimeout(() => {
                            if (toast.parentNode) {
                                toast.parentNode.removeChild(toast);
                            }
                            if (style.parentNode) {
                                style.parentNode.removeChild(style);
                            }
                        }, 300);
                    }
                }, displayTime);
                
                // è§¦è§‰åé¦ˆï¼ˆå¦‚æœæ”¯æŒï¼‰
                if (navigator.vibrate) {
                    if (type === 'error') {
                        navigator.vibrate([100, 50, 100]);
                    } else if (isSystemMessage) {
                        navigator.vibrate([50]);
                    }
                }
            }
        }

        // ===== éº¦å…‹é£æƒé™æ£€æŸ¥å‡½æ•° =====
        async function checkMicrophonePermission() {
            try {
                console.log('ğŸ” æ£€æŸ¥éº¦å…‹é£æƒé™...');
                
                // ç§»åŠ¨ç«¯å…¼å®¹æ€§æ£€æŸ¥ï¼šç›´æ¥å°è¯•æƒé™æŸ¥è¯¢
                if (navigator.permissions && typeof navigator.permissions.query === 'function') {
                    try {
                        const permission = await navigator.permissions.query({ name: 'microphone' });
                        console.log('ğŸ¤ éº¦å…‹é£æƒé™çŠ¶æ€:', permission.state);

                        if (permission.state === 'denied') {
                            showNotification('éº¦å…‹é£æƒé™è¢«æ‹’ç»ï¼Œè¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸éº¦å…‹é£è®¿é—®', 'error');
                            return false;
                        } else if (permission.state === 'prompt') {
                            console.log('ğŸ“± éœ€è¦ç”¨æˆ·æˆæƒéº¦å…‹é£æƒé™');
                        } else if (permission.state === 'granted') {
                            console.log('âœ… éº¦å…‹é£æƒé™å·²æˆäºˆ');
                        }
                    } catch (permissionError) {
                        console.warn('âš ï¸ æƒé™æŸ¥è¯¢å¤±è´¥(ç§»åŠ¨ç«¯å¯èƒ½ä¸æ”¯æŒ):', permissionError);
                    }
                } else {
                    console.log('ğŸ“± æµè§ˆå™¨ä¸æ”¯æŒæƒé™æŸ¥è¯¢APIï¼ˆå¸¸è§äºç§»åŠ¨ç«¯ï¼‰ï¼Œå°†ç›´æ¥å°è¯•è·å–åª’ä½“æµ');
                }

                // ç§»åŠ¨ç«¯å‹å¥½ï¼šç›´æ¥å°è¯•è·å–åª’ä½“æµæ¥æµ‹è¯•æƒé™
                try {
                    console.log('ğŸ§ª å°è¯•è·å–éº¦å…‹é£è®¿é—®æƒé™...');
                    const testStream = await navigator.mediaDevices.getUserMedia({ 
                        audio: { 
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true 
                        } 
                    });
                    
                    // ç«‹å³åœæ­¢æµ‹è¯•æµ
                    testStream.getTracks().forEach(track => track.stop());
                    console.log('âœ… éº¦å…‹é£æƒé™æµ‹è¯•æˆåŠŸ');
                    return true;
                    
                } catch (mediaError) {
                    console.error('âŒ éº¦å…‹é£è®¿é—®è¢«æ‹’ç»:', mediaError);
                    
                    // ç§»åŠ¨ç«¯å‹å¥½çš„é”™è¯¯æç¤º
                    if (mediaError.name === 'NotAllowedError') {
                        showNotification('è¯·å…è®¸éº¦å…‹é£è®¿é—®æƒé™ï¼Œè¯­éŸ³åŠŸèƒ½éœ€è¦ä½¿ç”¨éº¦å…‹é£', 'error');
                    } else if (mediaError.name === 'NotFoundError') {
                        showNotification('æœªæ‰¾åˆ°éº¦å…‹é£è®¾å¤‡', 'error');
                    } else {
                        showNotification('éº¦å…‹é£è®¿é—®å¤±è´¥: ' + mediaError.message, 'error');
                    }
                    return false;
                }

            } catch (error) {
                console.warn('âš ï¸ æƒé™æ£€æŸ¥è¿‡ç¨‹å‡ºé”™:', error);
                return true; // ç»§ç»­å°è¯•ï¼Œè®©åç»­æµç¨‹å¤„ç†
            }
        }

        // ===== äº‹ä»¶ç›‘å¬å™¨ç»‘å®š =====
        document.addEventListener('DOMContentLoaded', function () {
            console.log('ğŸ“‹ é¡µé¢DOMåŠ è½½å®Œæˆï¼Œæ£€æŸ¥å¹¶ç»‘å®šäº‹ä»¶ç›‘å¬å™¨...');

            // å®‰å…¨åœ°ç»‘å®šWebSocketæ§åˆ¶æŒ‰é’®äº‹ä»¶ï¼ˆåªç»‘å®šå­˜åœ¨çš„å…ƒç´ ï¼‰
            const wsConnectBtn = document.getElementById('wsConnectBtn');
            const wsDisconnectBtn = document.getElementById('wsDisconnectBtn');
            const wsVoiceToggleBtn = document.getElementById('wsVoiceToggleBtn');
            const wsRecordBtn = document.getElementById('wsRecordBtn');
            const wsSendAudioBtn = document.getElementById('wsSendAudioBtn');
            const wsSendTextBtn = document.getElementById('wsSendTextBtn');
            const wsStopAllBtn = document.getElementById('wsStopAllBtn');
            const wsResetBtn = document.getElementById('wsResetBtn');
            const wsTextInput = document.getElementById('wsTextInput');

            if (wsConnectBtn) wsConnectBtn.addEventListener('click', connectWebSocket);
            if (wsDisconnectBtn) wsDisconnectBtn.addEventListener('click', disconnectWebSocket);
            if (wsVoiceToggleBtn) wsVoiceToggleBtn.addEventListener('click', toggleVAD);
            if (wsRecordBtn) wsRecordBtn.addEventListener('click', toggleRecording);
            if (wsSendAudioBtn) wsSendAudioBtn.addEventListener('click', sendAudio);
            if (wsSendTextBtn) wsSendTextBtn.addEventListener('click', sendText);
            if (wsStopAllBtn) wsStopAllBtn.addEventListener('click', stopAllAudio);
            if (wsResetBtn) wsResetBtn.addEventListener('click', resetWebSocket);

            // æ–‡æœ¬è¾“å…¥Enteré”®å‘é€ï¼ˆå¦‚æœå…ƒç´ å­˜åœ¨ï¼‰
            if (wsTextInput) {
                wsTextInput.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        sendText();
                    }
                });
            }

            console.log('âœ… äº‹ä»¶ç›‘å¬å™¨ç»‘å®šå®Œæˆï¼ˆä»…ç»‘å®šå­˜åœ¨çš„å…ƒç´ ï¼‰');
        });

    </script>
</body>

</html>